# 模型健康度检查 - 使用示例

## 场景1：模型已运行

### 执行命令
```bash
使用SKILL检查 F:\导出全部对话副本.xlsx 的 全部对话 sheet，检查 对白内容 列
```

### 输出示例
```
============================================================
 SKILL执行器 - 游戏配置文本检查
============================================================

 解析指令...
✅ 指令解析成功

 检查参数:
   - 文件: F:\导出全部对话副本.xlsx
   - Sheet: 全部对话
   - 列名: 对白内容

 验证参数...
✅ 文件存在
✅ 参数验证通过

 启动检查任务...

============================================================
 快速配置检查工具 v2.2
============================================================

 正在验证模型: qwen3:14b-q4_K_M
✅ 模型存在: qwen3:14b-q4_K_M
 正在检查模型健康度: qwen3:14b-q4_K_M
 测试模型响应...
✅ 模型健康检查通过: qwen3:14b-q4_K_M

 正在加载数据...
✅ 成功加载 1003 行有效文本

 开始AI检查...
[进度条显示...]
```

**说明**：模型已运行，直接通过健康检查，立即开始检查任务。

---

## 场景2：模型未运行（自动启动）

### 执行命令
```bash
使用SKILL检查 F:\导出全部对话副本.xlsx 的 全部对话 sheet，检查 对白内容 列
```

### 输出示例
```
============================================================
 SKILL执行器 - 游戏配置文本检查
============================================================

 解析指令...
✅ 指令解析成功

 检查参数:
   - 文件: F:\导出全部对话副本.xlsx
   - Sheet: 全部对话
   - 列名: 对白内容

 验证参数...
✅ 文件存在
✅ 参数验证通过

 启动检查任务...

============================================================
 快速配置检查工具 v2.2
============================================================

 正在验证模型: qwen3:14b-q4_K_M
✅ 模型存在: qwen3:14b-q4_K_M
 正在检查模型健康度: qwen3:14b-q4_K_M
 测试模型响应...
⚠️ 模型未加载，正在启动模型...
 正在启动模型: qwen3:14b-q4_K_M
 执行命令: ollama run qwen3:14b-q4_K_M
⏳ 等待模型加载（约15-30秒）...
 验证模型状态 (1/3)...
✅ 模型启动成功: qwen3:14b-q4_K_M

 正在加载数据...
✅ 成功加载 1003 行有效文本

 开始AI检查...
[进度条显示...]
```

**说明**：检测到模型未运行，自动执行启动命令，等待加载完成后继续检查任务。

---

## 场景3：Ollama服务未启动

### 执行命令
```bash
使用SKILL检查 F:\导出全部对话副本.xlsx 的 全部对话 sheet，检查 对白内容 列
```

### 输出示例
```
============================================================
 SKILL执行器 - 游戏配置文本检查
============================================================

 解析指令...
✅ 指令解析成功

 检查参数:
   - 文件: F:\导出全部对话副本.xlsx
   - Sheet: 全部对话
   - 列名: 对白内容

 验证参数...
✅ 文件存在
✅ 参数验证通过

 启动检查任务...

============================================================
 快速配置检查工具 v2.2
============================================================

 正在验证模型: qwen3:14b-q4_K_M
⚠️ 无法连接到Ollama服务: Connection refused
⚠️ 无法验证模型，将尝试直接使用
 正在检查模型健康度: qwen3:14b-q4_K_M
❌ 无法连接到Ollama服务: Connection refused
 请确保Ollama服务正在运行

❌ 错误: 模型验证失败
```

**解决方案**：
```bash
# 启动Ollama服务
ollama serve
```

---

## 场景4：模型不存在

### 执行命令
```bash
使用SKILL检查 F:\导出全部对话副本.xlsx 的 全部对话 sheet，检查 对白内容 列
```

### 输出示例
```
============================================================
�� SKILL执行器 - 游戏配置文本检查
============================================================

 解析指令...
✅ 指令解析成功

 检查参数:
   - 文件: F:\导出全部对话副本.xlsx
   - Sheet: 全部对话
   - 列名: 对白内容

 验证参数...
✅ 文件存在
✅ 参数验证通过

 启动检查任务...

============================================================
 快速配置检查工具 v2.2
============================================================

 正在验证模型: qwen3:14b-q4_K_M
❌ 错误: 模型 'qwen3:14b-q4_K_M' 不存在！
 当前Ollama中可用的模型:
   1. qwen3-vl:8b
   2. nomic-embed-text:latest

 解决方案:
   1. 修改脚本中的 MODEL_NAME 为上述模型之一
   2. 或者使用命令下载模型: ollama pull qwen3:14b-q4_K_M

❌ 错误: 模型验证失败
```

**解决方案**：
```bash
# 下载模型
ollama pull qwen3:14b-q4_K_M
```

---

## 对比：之前 vs 现在

### 之前的使用流程

```
1. 用户: 使用SKILL检查文件
2. 系统: ❌ 错误：模型未运行
3. 用户: 打开新终端
4. 用户: 执行 ollama run qwen3:14b-q4_K_M
5. 用户: 等待模型加载（不知道要等多久）
6. 用户: 回到原终端
7. 用户: 重新执行SKILL检查
8. 系统: ✅ 开始检查

总耗时: ~2-3分钟（包括手动操作时间）
用户操作: 5步
```

### 现在的使用流程

```
1. 用户: 使用SKILL检查文件
2. 系统:  检查模型状态...
3. 系统: ⚠️ 模型未运行，自动启动中...
4. 系统: ⏳ 等待加载（显示进度）...
5. 系统: ✅ 模型启动成功，开始检查

总耗时: ~30秒（纯等待时间）
用户操作: 1步
```

### 改进效果

- ✅ 用户操作减少 80%（5步 → 1步）
- ✅ 总耗时减少 75%（2-3分钟 → 30秒）
- ✅ 无需切换终端
- ✅ 无需记忆命令
- ✅ 实时进度显示
- ✅ 自动化程度提升

---

## 技术细节

### 健康检查逻辑

```python
def check_model_health(model_name):
    # 1. 检查服务连接
    if not check_ollama_service():
        return False
    
    # 2. 测试模型响应
    response = test_model_response(model_name)
    
    # 3. 根据响应决定操作
    if response.status_code == 200:
        return True  # 模型健康
    elif response.status_code == 404:
        return start_model(model_name)  # 模型未加载，启动
    elif response.timeout:
        return start_model(model_name)  # 响应超时，启动
    else:
        return False  # 其他错误
```

### 启动重试机制

```python
def start_model(model_name):
    # 1. 执行启动命令
    subprocess.Popen(["ollama", "run", model_name])
    
    # 2. 等待加载
    time.sleep(15)
    
    # 3. 多次验证（最多3次）
    for i in range(3):
        if verify_model_loaded(model_name):
            return True
        time.sleep(5)  # 等待后重试
    
    return False
```

---

## 最佳实践

### 1. 首次使用

```bash
# 确保Ollama服务运行
ollama serve

# 下载模型（如果未下载）
ollama pull qwen3:14b-q4_K_M

# 直接使用SKILL（会自动检查和启动）
使用SKILL检查 <文件> 的 <Sheet> sheet，检查 <列名> 列
```

### 2. 日常使用

```bash
# 直接使用，无需关心模型状态
使用SKILL检查 <文件> 的 <Sheet> sheet，检查 <列名> 列
```

### 3. 批量任务

```bash
# 第一次会启动模型
使用SKILL检查 file1.xlsx 的 Sheet1 sheet，检查 text 列

# 后续任务模型已运行，直接检查
使用SKILL检查 file2.xlsx 的 Sheet1 sheet，检查 text 列
使用SKILL检查 file3.xlsx 的 Sheet1 sheet，检查 text 列
```

---

**版本**: v2.2  
**更新日期**: 2025-12-18

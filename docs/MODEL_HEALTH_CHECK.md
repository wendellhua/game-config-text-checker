# æ¨¡å‹å¥åº·åº¦æ£€æŸ¥åŠŸèƒ½ - å®Œæ•´è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

v2.2ç‰ˆæœ¬æ–°å¢äº†**æ¨¡å‹å¥åº·åº¦æ£€æŸ¥å’Œè‡ªåŠ¨å¯åŠ¨**åŠŸèƒ½ï¼Œä½¿SKILLèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹Ollamaæ¨¡å‹çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨æ¨¡å‹æœªè¿è¡Œæ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨å¹²é¢„ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ¨¡å‹å¥åº·åº¦æ£€æŸ¥ (`check_model_health`)

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦å¯è®¿é—®
- éªŒè¯æ¨¡å‹æ˜¯å¦å·²åŠ è½½åˆ°å†…å­˜
- æµ‹è¯•æ¨¡å‹å“åº”èƒ½åŠ›
- è‡ªåŠ¨è¯†åˆ«æ¨¡å‹æœªè¿è¡ŒçŠ¶æ€

**æ£€æŸ¥æµç¨‹**ï¼š
```
1. è¿æ¥OllamaæœåŠ¡ (http://30.30.51.20:11434)
   â†“
2. å‘é€æµ‹è¯•è¯·æ±‚éªŒè¯æ¨¡å‹æ˜¯å¦å·²åŠ è½½
   â†“
3. åˆ†æå“åº”çŠ¶æ€ï¼š
   - HTTP 200: æ¨¡å‹å¥åº· âœ…
   - HTTP 404: æ¨¡å‹æœªåŠ è½½ â†’ å¯åŠ¨æ¨¡å‹
   - Timeout: æ¨¡å‹æœªåŠ è½½ â†’ å¯åŠ¨æ¨¡å‹
   - å…¶ä»–é”™è¯¯: æŠ¥å‘Šé”™è¯¯ âŒ
```

### 2. è‡ªåŠ¨æ¨¡å‹å¯åŠ¨ (`start_model`)

**åŠŸèƒ½è¯´æ˜**ï¼š
- è‡ªåŠ¨æ‰§è¡Œ `ollama run <model_name>` å‘½ä»¤
- ç­‰å¾…æ¨¡å‹åŠ è½½å®Œæˆï¼ˆ15-30ç§’ï¼‰
- å¤šæ¬¡éªŒè¯æ¨¡å‹å¯åŠ¨çŠ¶æ€ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

**å¯åŠ¨æµç¨‹**ï¼š
```
1. æ‰§è¡Œå‘½ä»¤: ollama run qwen3:14b-q4_K_M
   â†“
2. ç­‰å¾…æ¨¡å‹åŠ è½½ï¼ˆ15ç§’ï¼‰
   â†“
3. éªŒè¯æ¨¡å‹çŠ¶æ€ï¼ˆæœ€å¤š3æ¬¡ï¼Œæ¯æ¬¡é—´éš”5ç§’ï¼‰
   â†“
4. è¿”å›å¯åŠ¨ç»“æœ
```

### 3. å¢å¼ºçš„æ¨¡å‹éªŒè¯ (`verify_model_exists`)

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨äºOllamaä¸­
- å¦‚æœå­˜åœ¨ï¼Œè¿›è¡Œå¥åº·åº¦æ£€æŸ¥
- å¦‚æœæœªè¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨æ¨¡å‹
- éªŒè¯å¯åŠ¨æˆåŠŸåç»§ç»­æ‰§è¡Œ

**éªŒè¯æµç¨‹**ï¼š
```
1. è·å–Ollamaä¸­çš„æ¨¡å‹åˆ—è¡¨
   â†“
2. æ£€æŸ¥ç›®æ ‡æ¨¡å‹æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
   â†“
3. å¦‚æœå­˜åœ¨ â†’ è¿›è¡Œå¥åº·åº¦æ£€æŸ¥
   â†“
4. å¦‚æœå¥åº· â†’ è¿”å›æˆåŠŸ âœ…
   å¦‚æœæœªè¿è¡Œ â†’ è‡ªåŠ¨å¯åŠ¨ â†’ è¿”å›ç»“æœ
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### æ–°å¢å‡½æ•°

#### 1. check_model_health(model_name)

```python
def check_model_health(model_name):
    """
    æ£€æŸ¥æ¨¡å‹å¥åº·åº¦ï¼Œå¦‚æœæ¨¡å‹æœªè¿è¡Œåˆ™è‡ªåŠ¨å¯åŠ¨
    
    Args:
        model_name: æ¨¡å‹åç§°
    
    Returns:
        bool: æ¨¡å‹æ˜¯å¦å¥åº·å¯ç”¨
    """
    # 1. æ£€æŸ¥OllamaæœåŠ¡è¿æ¥
    try:
        response = requests.get(f"{OLLAMA_API_URL}/tags", timeout=5)
        if response.status_code != 200:
            return False
    except Exception as e:
        print(f"âŒ æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡: {e}")
        return False
    
    # 2. æµ‹è¯•æ¨¡å‹å“åº”
    test_payload = {
        "model": model_name,
        "prompt": "æµ‹è¯•",
        "stream": False,
        "options": {"num_predict": 1}
    }
    
    try:
        response = requests.post(OLLAMA_URL, json=test_payload, timeout=10)
        if response.status_code == 200:
            return True
        elif response.status_code == 404:
            return start_model(model_name)
    except requests.exceptions.Timeout:
        return start_model(model_name)
    
    return False
```

#### 2. start_model(model_name)

```python
def start_model(model_name):
    """
    å¯åŠ¨æŒ‡å®šçš„Ollamaæ¨¡å‹
    
    Args:
        model_name: æ¨¡å‹åç§°
    
    Returns:
        bool: å¯åŠ¨æ˜¯å¦æˆåŠŸ
    """
    import subprocess
    
    # å¯åŠ¨æ¨¡å‹
    process = subprocess.Popen(
        ["ollama", "run", model_name, "--verbose"],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        stdin=subprocess.PIPE,
        text=True
    )
    
    # å‘é€æµ‹è¯•è¾“å…¥
    try:
        process.stdin.write("æµ‹è¯•\n")
        process.stdin.write("/bye\n")
        process.stdin.flush()
    except:
        pass
    
    # ç­‰å¾…åŠ è½½
    time.sleep(15)
    
    # éªŒè¯å¯åŠ¨ï¼ˆæœ€å¤š3æ¬¡ï¼‰
    for i in range(3):
        try:
            response = requests.post(OLLAMA_URL, json=test_payload, timeout=30)
            if response.status_code == 200:
                return True
        except:
            if i < 2:
                time.sleep(5)
    
    return False
```

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒ

### ä¹‹å‰çš„æµç¨‹

```
ç”¨æˆ·: ä½¿ç”¨SKILLæ£€æŸ¥æ–‡ä»¶
  â†“
ç³»ç»Ÿ: âŒ é”™è¯¯ï¼šæ¨¡å‹æœªè¿è¡Œ
  â†“
ç”¨æˆ·: æ‰‹åŠ¨æ‰§è¡Œ ollama run qwen3:14b-q4_K_M
  â†“
ç”¨æˆ·: ç­‰å¾…æ¨¡å‹åŠ è½½...
  â†“
ç”¨æˆ·: é‡æ–°è¿è¡ŒSKILLæ£€æŸ¥
  â†“
ç³»ç»Ÿ: âœ… å¼€å§‹æ£€æŸ¥
```

### ç°åœ¨çš„æµç¨‹

```
ç”¨æˆ·: ä½¿ç”¨SKILLæ£€æŸ¥æ–‡ä»¶
  â†“
ç³»ç»Ÿ: ğŸ” æ£€æŸ¥æ¨¡å‹çŠ¶æ€...
  â†“
ç³»ç»Ÿ: âš ï¸ æ¨¡å‹æœªè¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨ä¸­...
  â†“
ç³»ç»Ÿ: ğŸš€ æ­£åœ¨å¯åŠ¨æ¨¡å‹...
  â†“
ç³»ç»Ÿ: â³ ç­‰å¾…åŠ è½½...
  â†“
ç³»ç»Ÿ: âœ… æ¨¡å‹å¯åŠ¨æˆåŠŸï¼Œå¼€å§‹æ£€æŸ¥
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ— éœ€ç”¨æˆ·æ‰‹åŠ¨å¹²é¢„
- âœ… è‡ªåŠ¨åŒ–ç¨‹åº¦æ›´é«˜
- âœ… ç”¨æˆ·ä½“éªŒæ›´æµç•…
- âœ… é™ä½ä½¿ç”¨é—¨æ§›

---

## ğŸ“Š çŠ¶æ€æç¤º

### æ­£å¸¸æµç¨‹

```
ğŸ” æ­£åœ¨éªŒè¯æ¨¡å‹: qwen3:14b-q4_K_M
âœ… æ¨¡å‹å­˜åœ¨: qwen3:14b-q4_K_M
ğŸ¥ æ­£åœ¨æ£€æŸ¥æ¨¡å‹å¥åº·åº¦: qwen3:14b-q4_K_M
ğŸ” æµ‹è¯•æ¨¡å‹å“åº”...
âœ… æ¨¡å‹å¥åº·æ£€æŸ¥é€šè¿‡: qwen3:14b-q4_K_M
```

### éœ€è¦å¯åŠ¨æ¨¡å‹

```
ğŸ” æ­£åœ¨éªŒè¯æ¨¡å‹: qwen3:14b-q4_K_M
âœ… æ¨¡å‹å­˜åœ¨: qwen3:14b-q4_K_M
ğŸ¥ æ­£åœ¨æ£€æŸ¥æ¨¡å‹å¥åº·åº¦: qwen3:14b-q4_K_M
ğŸ” æµ‹è¯•æ¨¡å‹å“åº”...
âš ï¸ æ¨¡å‹æœªåŠ è½½ï¼Œæ­£åœ¨å¯åŠ¨æ¨¡å‹...
ğŸš€ æ­£åœ¨å¯åŠ¨æ¨¡å‹: qwen3:14b-q4_K_M
ğŸ“ æ‰§è¡Œå‘½ä»¤: ollama run qwen3:14b-q4_K_M
â³ ç­‰å¾…æ¨¡å‹åŠ è½½ï¼ˆçº¦15-30ç§’ï¼‰...
ğŸ” éªŒè¯æ¨¡å‹çŠ¶æ€ (1/3)...
âœ… æ¨¡å‹å¯åŠ¨æˆåŠŸ: qwen3:14b-q4_K_M
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### 1. OllamaæœåŠ¡ä¸å¯ç”¨

```
âŒ æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡: Connection refused
ğŸ’¡ è¯·ç¡®ä¿OllamaæœåŠ¡æ­£åœ¨è¿è¡Œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¯åŠ¨OllamaæœåŠ¡
ollama serve
```

### 2. ollamaå‘½ä»¤ä¸å­˜åœ¨

```
âŒ é”™è¯¯: æ‰¾ä¸åˆ° ollama å‘½ä»¤
ğŸ’¡ è¯·ç¡®ä¿ Ollama å·²æ­£ç¡®å®‰è£…å¹¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥Ollamaæ˜¯å¦å·²å®‰è£…
- ç¡®è®¤ollamaå‘½ä»¤åœ¨ç³»ç»ŸPATHä¸­
- Windows: é‡å¯ç»ˆç«¯æˆ–ç³»ç»Ÿ

### 3. æ¨¡å‹ä¸å­˜åœ¨

```
âŒ é”™è¯¯: æ¨¡å‹ 'qwen3:14b-q4_K_M' ä¸å­˜åœ¨ï¼
ğŸ“‹ å½“å‰Ollamaä¸­å¯ç”¨çš„æ¨¡å‹:
   1. qwen3-vl:8b
   2. nomic-embed-text:latest

ğŸ’¡ è§£å†³æ–¹æ¡ˆ:
   1. ä¿®æ”¹è„šæœ¬ä¸­çš„ MODEL_NAME ä¸ºä¸Šè¿°æ¨¡å‹ä¹‹ä¸€
   2. æˆ–è€…ä½¿ç”¨å‘½ä»¤ä¸‹è½½æ¨¡å‹: ollama pull qwen3:14b-q4_K_M
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¸‹è½½æ¨¡å‹
ollama pull qwen3:14b-q4_K_M
```

### 4. æ¨¡å‹å¯åŠ¨å¤±è´¥

```
âš ï¸ éªŒè¯è¶…æ—¶
â³ ç­‰å¾…5ç§’åé‡è¯•...
ğŸ” éªŒè¯æ¨¡å‹çŠ¶æ€ (2/3)...
âš ï¸ éªŒè¯è¶…æ—¶
â³ ç­‰å¾…5ç§’åé‡è¯•...
ğŸ” éªŒè¯æ¨¡å‹çŠ¶æ€ (3/3)...
âŒ æ¨¡å‹å¯åŠ¨å¤±è´¥ï¼Œå·²å°è¯• 3 æ¬¡
```

**å¯èƒ½åŸå› **ï¼š
- æœåŠ¡å™¨èµ„æºä¸è¶³
- æ¨¡å‹æ–‡ä»¶æŸå
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æœåŠ¡å™¨èµ„æºï¼ˆå†…å­˜ã€æ˜¾å­˜ï¼‰
- é‡æ–°ä¸‹è½½æ¨¡å‹
- æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## ğŸ”§ é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½®

åœ¨ `conf_check.py` ä¸­ï¼š

```python
# æ¨¡å‹é…ç½®
OLLAMA_URL = "http://30.30.51.20:11434/api/generate"
OLLAMA_API_URL = "http://30.30.51.20:11434/api"
MODEL_NAME = "qwen3:14b-q4_K_M"
```

### è¶…æ—¶é…ç½®

```python
# å¥åº·æ£€æŸ¥è¶…æ—¶
health_check_timeout = 10  # ç§’

# æ¨¡å‹å¯åŠ¨è¶…æ—¶
model_start_timeout = 30  # ç§’

# å¯åŠ¨ç­‰å¾…æ—¶é—´
model_load_wait = 15  # ç§’

# é‡è¯•æ¬¡æ•°
max_retries = 3
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [SKILL.md](../SKILL.md) - SKILLå®Œæ•´å®šä¹‰
- [README.md](../README.md) - é¡¹ç›®è¯´æ˜
- [CHANGELOG.md](../CHANGELOG.md) - æ›´æ–°æ—¥å¿—
- [FAQ.md](FAQ.md) - å¸¸è§é—®é¢˜

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•è„šæœ¬

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
python test_model_health.py
```

### æ‰‹åŠ¨æµ‹è¯•

1. **æµ‹è¯•æ¨¡å‹å·²è¿è¡Œçš„æƒ…å†µ**ï¼š
   ```bash
   # å…ˆå¯åŠ¨æ¨¡å‹
   ollama run qwen3:14b-q4_K_M
   
   # ç„¶åè¿è¡Œæ£€æŸ¥
   python scripts/skill_executor.py "ä½¿ç”¨SKILLæ£€æŸ¥ test.xlsx çš„ Sheet1 sheetï¼Œæ£€æŸ¥ text åˆ—"
   ```
   
   é¢„æœŸç»“æœï¼š
   ```
   âœ… æ¨¡å‹å¥åº·æ£€æŸ¥é€šè¿‡
   ```

2. **æµ‹è¯•æ¨¡å‹æœªè¿è¡Œçš„æƒ…å†µ**ï¼š
   ```bash
   # ç¡®ä¿æ¨¡å‹æœªè¿è¡Œï¼ˆå¯ä»¥é‡å¯OllamaæœåŠ¡ï¼‰
   
   # è¿è¡Œæ£€æŸ¥
   python scripts/skill_executor.py "ä½¿ç”¨SKILLæ£€æŸ¥ test.xlsx çš„ Sheet1 sheetï¼Œæ£€æŸ¥ text åˆ—"
   ```
   
   é¢„æœŸç»“æœï¼š
   ```
   âš ï¸ æ¨¡å‹æœªåŠ è½½ï¼Œæ­£åœ¨å¯åŠ¨æ¨¡å‹...
   ğŸš€ æ­£åœ¨å¯åŠ¨æ¨¡å‹...
   âœ… æ¨¡å‹å¯åŠ¨æˆåŠŸ
   ```

---

## ğŸ‰ æ€»ç»“

v2.2ç‰ˆæœ¬çš„æ¨¡å‹å¥åº·åº¦æ£€æŸ¥åŠŸèƒ½å¸¦æ¥äº†ä»¥ä¸‹æ”¹è¿›ï¼š

### ä¼˜åŠ¿

1. **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨å¯åŠ¨æ¨¡å‹
2. **æ™ºèƒ½åŒ–**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æ¨¡å‹çŠ¶æ€
3. **å‹å¥½æ€§**ï¼šæ¸…æ™°çš„çŠ¶æ€æç¤ºå’Œé”™è¯¯ä¿¡æ¯
4. **å¯é æ€§**ï¼šå¤šæ¬¡é‡è¯•å’Œå®Œå–„çš„é”™è¯¯å¤„ç†
5. **æ˜“ç”¨æ€§**ï¼šé™ä½ä½¿ç”¨é—¨æ§›ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### é€‚ç”¨åœºæ™¯

- âœ… é¦–æ¬¡ä½¿ç”¨SKILL
- âœ… æœåŠ¡å™¨é‡å¯å
- âœ… æ¨¡å‹é•¿æ—¶é—´æœªä½¿ç”¨è¢«å¸è½½
- âœ… å¤šç”¨æˆ·å…±äº«OllamaæœåŠ¡
- âœ… è‡ªåŠ¨åŒ–è„šæœ¬å’ŒCI/CDæµç¨‹

### æŠ€æœ¯äº®ç‚¹

- ğŸ¯ ç²¾å‡†çš„çŠ¶æ€æ£€æµ‹
- ğŸ”„ æ™ºèƒ½çš„é‡è¯•æœºåˆ¶
- â±ï¸ åˆç†çš„è¶…æ—¶è®¾ç½®
- ğŸ“ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- ğŸ›¡ï¸ å®Œå–„çš„é”™è¯¯å¤„ç†

---

**ç‰ˆæœ¬**: v2.2  
**æ›´æ–°æ—¥æœŸ**: 2025-12-18  
**ä½œè€…**: AI Assistant
